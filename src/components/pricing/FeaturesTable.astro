---
import { URLS } from '../../constants';
import { FALLBACK_PLANS } from './constants';
import type { ClerkPlan } from './types';

interface Props {
  freePlan?: ClerkPlan;
  plusPlan?: ClerkPlan;
  proPlan?: ClerkPlan;
}

const { freePlan, plusPlan, proPlan } = Astro.props;

// We only use the table if there are features to compare
const shouldRender = plusPlan?.features?.length || proPlan?.features?.length;

const plusFreeTrialDays = plusPlan?.freeTrialDays ?? FALLBACK_PLANS.plus.freeTrialDays;
const proFreeTrialDays = proPlan?.freeTrialDays ?? FALLBACK_PLANS.pro.freeTrialDays;

// Helper to parse feature slug into base key and display value
const parseFeature = (slug: string) => {
    let base = slug;
    let value = null;

    // Check for "unlimited"
    if (/unlimited/i.test(slug)) {
        value = 'Unlimited';
        base = slug.replace(/unlimited/i, '');
    } else {
        // Match numbers (including those with underscores/commas)
        // We use a non-capturing group for the boundary check
        const numMatch = slug.match(/(?:^|[_\W])(\d+(?:[_,]\d+)*)(?:$|[_\W])/);
        if (numMatch) {
            value = numMatch[1].replace(/_/g, ',');
            // Remove just the number part from the slug
            base = slug.replace(numMatch[1], '');
        }
    }

    // Clean up base slug (remove duplicate/trailing underscores)
    base = base.replace(/__+/g, '_').replace(/^_+|_+$/g, '');

    return { base, value };
};

// 1. Collect all unique features keyed by baseSlug
const featureMap = new Map<string, { label: string }>();

[freePlan, plusPlan, proPlan].forEach(plan => {
    plan?.features?.forEach(f => {
        const { base } = parseFeature(f.slug);

        // Clean up label: remove numbers to make it generic
        // e.g. "3,000 Monthly Requests" -> "Monthly Requests"
        // e.g. "1 User Access Key" -> "User Access Key"
        let label = f.name;
        // Remove any sequence of digits (with optional commas)
        label = label.replace(/\b[\d,]+\b/g, '').trim();
        // Remove extra spaces if any
        label = label.replace(/\s+/g, ' ');

        featureMap.set(base, { label });
    });
});

// 2. Build rows
const rows = Array.from(featureMap.entries()).map(([baseSlug, { label }]) => {
    const getDisplayValue = (plan: ClerkPlan | undefined) => {
        // Find feature in this plan that matches the base slug
        const feature = plan?.features?.find(f => parseFeature(f.slug).base === baseSlug);
        if (!feature) return '—';

        const { value } = parseFeature(feature.slug);
        // If no value was extracted (no number/unlimited), treat as boolean
        return value ?? '✓';
    };

    return {
        id: baseSlug,
        label: label,
        freeValue: getDisplayValue(freePlan),
        plusValue: getDisplayValue(plusPlan),
        proValue: getDisplayValue(proPlan),
    };
});
---

{shouldRender && (
    <div class="features-table-section">
        <h2 class="features-table-title">Compare Features</h2>
        <div class="features-table-wrapper">
            <table class="features-table">
                <thead>
                    <tr>
                        <th>Feature</th>
                        <th>Free</th>
                        <th class="featured-column">Plus</th>
                        <th>Pro</th>
                    </tr>
                </thead>
                <tbody>
                    {rows.map((row) => (
                        <tr>
                            <td class="feature-name">{row.label}</td>
                            <td class="feature-check">
                                <span class={`${row.freeValue === '✓' ? 'check-icon' : row.freeValue === '—' ? 'check-icon no' : 'feature-value'}`}>
                                    {row.freeValue}
                                </span>
                            </td>
                            <td class="feature-check featured-column">
                                <span class={`${row.plusValue === '✓' ? 'check-icon' : row.plusValue === '—' ? 'check-icon no' : 'feature-value'}`}>
                                    {row.plusValue}
                                </span>
                            </td>
                            <td class="feature-check">
                                <span class={`${row.proValue === '✓' ? 'check-icon' : row.proValue === '—' ? 'check-icon no' : 'feature-value'}`}>
                                    {row.proValue}
                                </span>
                            </td>
                        </tr>
                    ))}
                </tbody>
                <tfoot>
                    <tr class="table-actions-row">
                        <td></td>
                        <td class="table-action-cell">
                            <a href={URLS.APP} class="btn btn-secondary table-btn">Get Started</a>
                        </td>
                        <td class="table-action-cell featured-column">
                            <a href={`${URLS.APP}/pricing`} class="btn btn-primary table-btn">Start {plusFreeTrialDays} Day Trial</a>
                        </td>
                        <td class="table-action-cell">
                            <a href={`${URLS.APP}/pricing`} class="btn btn-secondary table-btn">Start {proFreeTrialDays} Day Trial</a>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
)}
